(function(t){"use strict";var e="app",n="value",i="values",r="text",s="$shown",o="$deps",a="attrs",u="routes",h="_item_name",c="data-index",l="data-tie",p="data-tied",d=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)};Array.prototype._=function(t){return U.forEach(this,function(e){t.hasOwnProperty(e)||(t[e]={_item_name:e})}),t};var f=function(t){var e=function(e,n,r){if(!n||!n._proxyMark){var o=function(){return n?n.get?n.get.call(e):n.value:e.$attr(r)},h=function(o){n?n.set?n.set.call(this,o):n.value=o:e.$attr(r,o),r==s?t.show(o):(r==a?t.prepareAttrs():r==u?t.prepareRoutes():r==i&&t.prepareValues(),U.debug("Calling apply on '"+t.name+"' after changed property '"+r+"'"),t.apply())},c=n?n.enumerable:!1;Object.defineProperty(e,r,{get:o,set:h,configurable:!0,enumerable:c,_proxyMark:!0})}},n=function(r){for(var s in r)if(r.hasOwnProperty(s)){if(h.push(s),"prototype"==s)continue;var c=Object.getOwnPropertyDescriptor(r,s);if(c._proxyMark)continue;if(!c.configurable||void 0===c.value&&!c.set||c.writable===!1)continue;var l="$"===s.charAt(0)&&-1!=t.depends.indexOf(s.substring(1)),p=r[s];U.isObject(p)&&!l&&s!=a&&s!=u&&s!=o&&s!=i&&(U.debug("Exploring "+s),n(p)),U.debug("Observing "+s),e(r,c,s,l)}r.attrs&&U.forIn(r.attrs,function(t,n){-1==h.indexOf(n)&&(t.property||t.value)&&(U.debug("Observing attribute "+n),e(r,null,n),h.push(n))},this)},r=t.obj,h=[];return U.debug("Exploring "+t.name),n(r),r},v={list:{},init:function(){if(null==F)throw Error("App is not ready");F.obj.routes&&(U.forIn(F.obj.routes,function(t,e){e=e.toLowerCase(),this.list[e]=new y(e,t.handler)},this),U.debug("Routes init"))},locate:function(e){var n=t.location.hash.substring(1);n=this.find(n),n?(U.debug("Process route "+n.path),F.location=function(e){return e?(this.move(e),null):{href:t.location.href,route:n}}.bind(this),n.handler&&P(n.handler,F.obj),U.forIn(e,function(t){var e=t.obj;e.$location=F.location;var i=n.has(e);e.$shown=i,t.rendered||t.render(),t.validateShow();var r=e.routes;if(r&&i){var s=r[n.path];s&&s.handler&&P(s.handler,e)}}),U.debug("Processed route "+n.path)):F.obj.routes?this.move("/"):(U.debug("Process default route"),U.forIn(e,function(t){t.rendered||t.render(),t.obj.$location=function(){return{route:{has:function(){return!0}}}},t.obj.$shown=!0}),U.debug("Processed default route"))},find:function(t){return this.list[t]},move:function(e){setTimeout(function(){t.location.hash="#"+e},100)}},y=function(t,e){this.path=t,this.handler=e};y.prototype={has:function(t){var e=t.routes;if(e){var n=null!=e["-"],i=!1;return U.forIn(e,function(t,e){return e.toLowerCase()==this.path?(i=!0,!1):!0},this),n!=i}return!1}};var b={},g=function(t,e,n){if(U.isUndefined(e))return b[t];var i={canWrite:!1,changeRoutes:!1,changeAttrs:!1};U.isDefined(n)&&U.extend(i,n);var r={fn:e,opts:i},s=new D(r);return b[t]=s,s},m=function(t){var e=t.split(":");if(this.name=U.trim(e[0]),this.params="",e.length>1){var n=e[1];n=U.trim(n),n="["+n+"]",this.params=n}};m.prototype={process:function(t,e){var n=b[this.name];if(!n)throw Error("Pipe "+this.name+" not found");var i=n.fn,r=[];if(this.params.length>0){var s=U.extend({},t);s=U.extend(s,n);var o=U.convert(this.params,s);U.forEach(o,function(t){t=U.trim(t),r.push(t)})}var a=U.isDefined(e)&&this.canWrite()?t:U.clone(t);return i&&U.isFunction(i)&&(a=P(i,n,!0,a,r,e)),a},canWrite:function(){var t=b[this.name];return t?t.opts.canWrite:!1},changeRoutes:function(){var t=b[this.name];return t?t.opts.changeRoutes:!1},changeAttrs:function(){var t=b[this.name];return t?t.opts.changeAttrs:!1}};var $={type:"GET",mime:"json"},j={script:"text/javascript, application/javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},x=function(t){t&&U.extend(this,t)},E=function(t,e){var n="";e&&(n=e.indexOf("?")+1?"&":"?");var i=n;return U.forIn(t,function(t,e){i!==n&&(i+="&"),i+=e+"="+t}),i===n?"":i},w=function(t,e,n){var i=t.status;i>=200&&300>i||0===i?A(O(t,e,n),null,n):A(t.responseText,i,n)},A=function(t,e,n){P(n,obj,!0,t,e)},C=function(t,e,n,i){i&&(e["Content-Type"]=i),n&&(e.Accept=j[n]),U.forIn(e,function(e,n){t.setRequestHeader(n,e)})},O=function(t,e,n){var i;if(i=t.responseText)if(e===$.mime)try{i=JSON.parse(i)}catch(r){A(i,r,n)}else"xml"===e&&(i=t.responseXML);return i},S=function(t,e,n){return t[e]?t[e]:F&&F.connect&&F.connect[e]?F.connect[e]:n},I=function(t,e){U.forIn(e,function(e,n){e&&(t[n]=e)})};x.prototype={ajax:function(){var e=this.getType(),n=this.getUrl(),i=this.getData(),r=this.getDataType(),s=this.getContentType(),o=this.getHeaders(),a=this.getCallback();if(e===$.type?n+=E(i,n):i=E(i),/=\$JSONP/gi.test(n))return this.jsonp(n,i,a);var u=new t.XMLHttpRequest;u.onreadystatechange=function(){return 4===u.readyState?w(u,r,a):null},u.open(e,n),C(u,o,s,r);try{u.send(i)}catch(h){u=h,A(null,h,a)}return u},jsonp:function(e,n,i){var r=t.document.getElementsByTagName("head")[0],s=t.document.createElement("script");e+=this.params(n,e);var o="jsonp"+U.uid();t[o]=function(e){return r.removeChild(s),delete t[o],i(e)},s.type="text/javascript",s.src=e.replace(/=\$JSONP/gi,"="+o),r.appendChild(s)},get:function(t,e,n,i){return I(this,{type:$.type,url:t,data:e,callback:i,dataType:n}),this.ajax()},post:function(t,e,n,i){return this.form("POST",t,e,n,i)},put:function(t,e,n,i){return this.form("PUT",t,e,n,i)},del:function(t,e,n,i){return this.form("DELETE",t,e,n,i)},"delete":function(t,e,n,i){return this.form("DELETE",t,e,n,i)},form:function(t,e,n,i,r){return I(this,{type:t,url:e,data:n,callback:r,dataType:i,contentType:"application/x-www-form-urlencoded"}),this.ajax()},getUrl:function(){var t=S(this,"url","");if(!t)throw Error("URL is not defined")},getData:function(){return S(this,"data",{})},getType:function(){return S(this,"type",$.type)},getContentType:function(){return S(this,"contentType",null)},getDataType:function(){return S(this,"dataType",$.mime)},getHeaders:function(){return S(this,"header",[])},getCallback:function(){return S(this,"callback",[])}};var T={next:function(t,e){var n=t.parentNode;U.forEach(e,function(e){n.insertBefore(e,t.nextSibling),t=e})},remove:function(t){var e=t.parentNode;e&&e.removeChild(t)},ready:function(e){"complete"===document.readyState?setTimeout(e,0):t.addEventListener("load",e),t.addEventListener("hashchange",e)}},k=function(t,e){var n=function(n){U.debug("Fired '"+n.type+"' listener on '"+e.name+"' for element "+t.tagName);var i=this.value();i=U.trim(i),this.pipes.length>0?this.pipeline(i):e.obj.value!==i&&(e.obj.value=i)}.bind(this),i=t.getAttribute(c);this.$=t,this._id=U.uid(),this.index=i?parseInt(i):-1,this.tie=t.getAttribute(l),this.bind=e,this.events={},this.isInput=U.eqi(t.tagName,"input"),this.hasCheck=U.eqi(t.type,"radio")||U.eqi(t.type,"checkbox"),this.display=t.style.display,this.shown=!0,this.textEl=null,this.isInput&&(this.hasCheck?(U.debug("Added change listener on '"+e.name+"' for element "+t.tagName),t.addEventListener("change",n)):"oninput"in t?(U.debug("Added input listener on '"+e.name+"' for element "+t.tagName),t.addEventListener("input",n)):(U.debug("Added keydown listener on '"+e.name+"' for element "+t.tagName),t.addEventListener("keydown",function(t){var e=t.keyCode;91===e||e>15&&19>e||e>=37&&40>=e||n(t)})));var r=this.tie.replace(/\.([^.|]+(\.[^.|]+)*)/g,'|property:"$1"').match(/[^|]+/g).splice(1);this.pipes=[],U.forEach(r,function(t){this.pipes.push(new m(t))},this),this.pipeline=function(t){var e=this.bind.obj;return this.pipes.length>0&&U.forEach(this.pipes,function(n){e=U.isDefined(t)?n.process(e,t):n.process(e),n.changeRoutes()&&U.isUndefined(t)&&U.isFunction(e.$location)&&(e.$shown=e.$location().route.has(e))},this),e}};k.prototype={setAttribute:function(t,e){if(n===t)this.value(e);else if(r===t)this.text(e);else if(U.isFunction(e)){var i=this.events[t];i&&this.$.removeEventListener(t,i),i=function(t){t.index=this.index,t.tie=this.tie,P(e,this.bind.obj,this.bind.obj.$ready(),t)}.bind(this),this.events[t]=i,this.$.addEventListener(t,i)}else U.isDefined(e)?this.$.setAttribute(t,e):this.$.setAttribute(t,"")},value:function(t){if(this.hasCheck){if(!U.isDefined(t))return this.$.checked;t?this.$.setAttribute("checked","checked"):this.$.removeAttribute("checked")}else{if(!this.isInput)return this.text(t);if(!U.isDefined(t))return this.$.value;this.$.value=t}return null},text:function(e){return U.isDefined(e)?(this.isInput?(null==this.textEl&&(this.textEl=t.document.createElement("span"),this.next(this.textEl)),this.textEl.textContent=e):this.$.textContent=e,null):this.isInput?this.$.nextSibling.textContent||"":this.$.textContent||""},remove:function(){var t=this.$,e=this.bind.$;e.splice(e.indexOf(this),1),delete this.$,delete this.bind,delete this._id,delete this.isInput,delete this.hasCheck,delete this.events,T.remove(t)},next:function(t){var e=this.$;T.next(e,t)},show:function(t){this.shown!==t&&(t?(this.$.style.display=this.display,null!=this.textEl&&(this.textEl.style.display=this.display)):(this.display=this.$.style.display,this.$.style.display="none",null!=this.textEl&&(this.textEl.style.display="none")),this.shown=t)}};var U={debugEnabled:!1,isUndefined:function(t){return void 0==t},isDefined:function(t){return void 0!=t},isObject:function(t){return null!=t&&"object"==typeof t},isString:function(t){return"string"==typeof t},isNumber:function(t){return"number"==typeof t},isDate:function(t){return"[object Date]"==Object.prototype.toString.apply(t)},isArray:function(t){return Array.isArray(t)||"[object Array]"==Object.prototype.toString.apply(t)},isCollection:function(t){return this.isArray(t)||t instanceof Array||"[object NodeList]"==Object.prototype.toString.apply(t)||"[object NamedNodeMap]"==Object.prototype.toString.apply(t)||"[object Arguments]"==Object.prototype.toString.apply(t)},isFunction:function(t){return"function"==typeof t},isBoolean:function(t){return"boolean"==typeof t},trim:function(t){return this.isString(t)?t.replace(/^\s*/,"").replace(/\s*$/,""):t},lowercase:function(t){return this.isString(t)?t.toLowerCase():t},uppercase:function(t){return this.isString(t)?t.toUpperCase():t},toInt:function(t){return parseInt(t,10)},toFloat:function(t){return parseFloat(t)},eqi:function(t,e){return this.lowercase(t)===this.lowercase(e)},clone:function(t){if(!t||!this.isObject(t))return t;var e=this.isArray(t)?[]:Object.create(Object.getPrototypeOf(t));return e=this.extend(e,t,function(t){return t&&this.isObject(t)&&(t=this.clone(t)),t}.bind(this))},convert:function(t,e){var n=t,i=function(t,n){return U.isString(n)&&"#"==n[0]?e[n.substring(1)]:n};return"true"===t?n=!0:"false"===t?n=!1:/^\d*$/.test(t)?n=-1!=t.indexOf(".")?this.toFloat(t):this.toInt(t):"["==t[0]&&"]"==t[t.length-1]?(t=t.replace(/'/g,'"'),n=JSON.parse(t,i)):"{"==t[0]&&"}"==t[t.length-1]?(t=t.replace(/'/g,'"'),n=JSON.parse(t,i)):('"'==t[0]||"'"==t[0])&&(n=t.substring(1,t.length-1)),n},forEach:function(t,e,n,i){if(n||(n=this),e)if(this.isCollection(t)){var r=-1,s=t.length,o=[];if(i){for(;s>++r;)o.push(t[r]);r=-1}else o=t;for(;s>++r&&e.call(n,o[r],r,t)!==!1;);}else e.call(n,t,0,[t]);return t},forIn:function(t,e,n,i){if(n||(n=this),e)for(var r in t)if((t.hasOwnProperty(r)||i)&&e.call(n,t[r],r,t)===!1)break;return t},uid:function(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()},extend:function(t,e,n){return this.isCollection(t)&&this.isCollection(e)?this.forEach(e,function(e,i){n&&(e=n(e,i)),t.push(e)}):this.forIn(e,function(e,i){n&&(e=n(e,i)),t[i]=e},this),t},debug:function(t,e){this.debugEnabled&&(e&&(console.groupEnd(),console.groupCollapsed(e)),console.log(t))}},D=function(t){U.extend(this,t)};D.prototype=U,D.prototype.$attr=function(t,e){if(this.attrs){var n=this.attrs[t];if(U.isUndefined(e)){if(n)return n.val(this)}else n&&n.property?this.$prop(n.property,e):n&&this.$prop(t,e)}return null},D.prototype.$prop=function(t,e){for(var n=this,i=t.split("."),r=1,s=i.length;s>r;)n=n[i[r-1]],r++;var o=i[s-1];return U.isUndefined(e)?n[o]:(n[o]=e,null)},D.prototype.$ready=function(){var t=!0;return U.forEach(this.$deps,function(e){var n=this["$"+e];return n._empty?(t=!1,!1):!0},this),t};var P=function(t,e,n){var i,r=3;U.isUndefined(n)&&U.isFunction(e.$ready)&&(n=e.$ready(),r=2);try{var s=Array.prototype.slice.call(arguments,r);i=t.apply(e,s)}catch(o){i=void 0,n&&(console.groupCollapsed("User code error"),console.error("Is ready and had an error:"+o.message),console.dir(o),console.groupEnd())}return i},N=function(t,e,i){U.isUndefined(i)&&(i=-1);var r=t.values;return i>=0&&r&&U.isDefined(r[i][e])?r[i][e]:i>=0&&r&&n==e?r[i]:t.$prop(e)},R=function(t,e,n){var i=this.name,r=this.value,s=this.property;if(U.isUndefined(n)&&(n=t.$ready()),U.isFunction(r))return P(r,t,n);if(s&&U.isUndefined(r))return N(t,s,e);if(!i)throw Error("Where is your property?");return N(t,i,e)},_=function(t,e,n){this.name=t,this.touch=[],this.values={},this.depends=e||[],this.rendered=!1,this.loaded=!1,this.loading=!1,this.selected=!1,this.applyCount=0,this.timeout=null,this.e=0,this.apply=function(){this.applyCount++,this.applyCount>10&&U.debug("Too many apply :"+this.name+" - "+this.applyCount),this.rendered&&this.render(),U.forEach(this.touch,function(t){var e=n[t];e&&(e.obj["$"+this.name]=this.obj)},this),this.timeout||(this.timeout=setTimeout(function(){this.timeout=null,this.applyCount=0}.bind(this),3e3))}};_.prototype={prepareRoutes:function(){var t=this.obj.routes;t&&(U.isArray(t)&&(this.obj.routes=t._({})),U.forIn(this.obj.routes,function(t,e){t=U.isFunction(t)?{path:e,handler:t}:{path:e},this.obj.routes[e]=t},this))},prepareAttrs:function(){var t=this.obj.attrs;t&&(U.isArray(t)&&(this.obj.attrs=t._({})),U.forIn(this.obj.attrs,function(t,e){U.isString(t)&&"#"==t[0]?t={name:e,property:t.substring(1)}:U.isFunction(t)?t={name:e,value:t}:t[h]?t.name=t[h]:t={name:e,value:t},this.obj.attrs[e]=t},this))},prepareValues:function(){var t=this.obj.values;if(t){if(this.$.length-this.e==t.length)return this.rendered=!1,void 0;var e={},n={};U.forEach(this.$,function(t){t.index>=0&&t.remove()},this,!0),U.forEach(t,function(t,i){U.forEach(this.$,function(t){var r=t._id,s=n[r];s||(n[r]=s=t.$);var o=e[r];o||(e[r]=o=[]);var a=s.cloneNode(!0);s.style.display="",a.setAttribute(c,i),o.push(a)})},this),U.forEach(this.$,function(t){var n=t.$;n.style.display="none",T.next(n,e[t._id])}),this.selected=!1}},renderAttr:function(t,e){U.forEach(this.$,function(n){if(n){var i=e;if(U.isFunction(e)){var r=n.pipeline();i=e(r,n.index),U.debug("Render attribute '"+t+"' with value "+i)}n.setAttribute(t,i)}})},show:function(t){this.rendered&&U.forEach(this.$,function(e){e&&e.show(t)},this)},validateShow:function(){this.loaded||this.loading||this.load(),U.forEach(this.$,function(t){if(t){var e=t.pipeline().$shown;e&&!this.rendered&&this.render(),t.show(e)}},this)},render:function(){if(this.obj.$shown){U.debug("Render "+this.name,this.name+" Render"),this.loaded||this.loading||this.load();var t=this.obj.attrs;if(t){var e=this.obj.$ready();U.forIn(t,function(t){t.val=R,this.renderAttr(t.name,function(n,i){return t.val(n,i,e)}.bind(this))},this),this.renderAttr(p),U.forEach(this.$,function(t){t.isInput&&t.setAttribute("name",this.name)},this)}this.show(this.obj.$shown),this.rendered=!0,U.debug("Rendered "+this.name)}}};var F=null,L=function(){var n={};return function(i,r,s){i!=e&&null==n[e]&&t.tie(e,{});var o=n[i];if(!o||o.obj._empty||!U.isUndefined(s)&&o.depends!==s){var a=L.prototype.init(i,r,s,n);return L.prototype.define(i,a,n),i==e&&(F=a,v.init(),T.ready(function(){v.locate(n)})),a.obj}return L.prototype.update(o,r)}};L.prototype={select:function(e,n){var i=t.document.querySelectorAll("["+l+'="'+e+'"]'),r=[];return U.forEach(i,function(t){r.push(new k(t,n))}),i=t.document.querySelectorAll("["+l+'^="'+e+'|"]'),U.forEach(i,function(t){r.push(new k(t,n))}),i=t.document.querySelectorAll("["+l+'^="'+e+' |"]'),U.forEach(i,function(t){r.push(new k(t,n))}),i=t.document.querySelectorAll("["+l+'^="'+e+'."]'),U.forEach(i,function(t){r.push(new k(t,n))}),n.selected=!0,r},wrapPrimitive:function(t){return{value:t,attrs:[n]}},wrapFunction:function(t){return{attrs:{value:t}}},wrapArray:function(t){return{values:t,attrs:[n]}},check:function(t){return U.isFunction(t)?t=this.wrapFunction(t):!U.isObject(t)||U.isDate(t)?t=this.wrapPrimitive(t):U.isArray(t)&&(t=this.wrapArray(t)),U.isUndefined(t.$shown)&&(t.$shown=!0),U.isUndefined(t.attrs)&&(t.attrs={}),U.isUndefined(t.routes)&&null!=F&&F.obj.routes&&(t.routes=F.obj.routes),new D(t)},resolve:function(t,e,n){e&&U.forEach(e,function(e){var i=n[e];i||(i={name:e,touch:[],obj:{_empty:!0}},this.define(e,i,n)),t.obj["$"+e]=i.obj,-1==i.touch.indexOf(t.name)&&i.touch.push(t.name)},this)},define:function(t,e,n){var i=n[t];n[t]=e,i&&i.touch&&(e.touch=i.touch,e.rendered=i.rendered,U.debug("Calling apply on '"+e.name+"' after define"),e.apply())},update:function(t,e){var n=t.name;return U.debug("Update tie "+n,n),U.extend(t.obj,this.check(e)),t.prepareAttrs(),t.prepareRoutes(),t.prepareValues(),U.debug("Prepared inner array structure"),t.obj=f(t),t.selected||(this.$=L.select(n,t),U.debug("Elements reselected: "+this.$.length)),t.rendered||t.render(),prev},init:function(t,e,n,i){U.debug("Tie "+t,t);var r=new _(t,n,i);r.obj=this.check(e),r.prepareAttrs(),r.prepareRoutes(),this.resolve(r,n,i),r.obj.$deps=r.depends,r.obj=f(r),U.debug("Bind model ready");var s=this;return r.load=function(){this.loading=!0,this.selected||(this.$=s.select(t,r),this.e=this.$.length,U.debug("Elements selected: "+this.$.length)),r.prepareValues(),U.debug("Prepared inner array structure"),this.selected||(this.$=s.select(t,r),U.debug("Elements reselected: "+this.$.length)),this.loaded=!0,this.loading=!1},r}},t.tie=L(),t.tie.pipes=g,g("property",function(t,e,i){if(e){var r=e[0],s=e.length>1?e[1]:n;U.isUndefined(i)?t.$prop(s,t.$prop(r)):t.$prop(r,i)}return t},{canWrite:!0}),g("value",function(t,e){if(e){var n=e[0],i=e.length>1?e[1]:null;t.$prop(n,i)}return t}),g("routes",function(t,e){if(e){var n="+"===e[0],i="-"===e[0];n?(e.splice(0,1),this.forEach(e,function(e){t.routes[e]={path:e}})):i?(e.splice(0,1),this.forEach(e,function(e){delete t.routes[e]})):(t.routes={},this.forEach(e,function(e){t.routes[e]={path:e}}))}return t},{changeRoutes:!0})})(window);