(function(t){"use strict";var e="app",n="value",i="values",r="text",s="$shown",o="$deps",a="attrs",u="routes",h="_item_name",c="data-index",d="data-tie",l="data-tied",p=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)};Array.prototype._=function(t){return N.forEach(this,function(e){t.hasOwnProperty(e)||(t[e]={_item_name:e})}),t};var f=function(t){var e=function(e,n,r){if(!n||!n._proxyMark){var o=function(){return n?n.get?n.get.call(e):n.value:e.$attr(r)},h=function(o){n?n.set?n.set.call(this,o):n.value=o:e.$attr(r,o),r==s?t.show(o):(r==a?t.prepareAttrs():r==u?t.prepareRoutes():r==i&&t.prepareValues(),N.debug("Calling apply on '"+t.name+"' after changed property '"+r+"'"),t.apply())},c=n?n.enumerable:!1;Object.defineProperty(e,r,{get:o,set:h,configurable:!0,enumerable:c,_proxyMark:!0})}},n=function(r){for(var s in r)if(r.hasOwnProperty(s)){if(h.push(s),"prototype"==s)continue;var c=Object.getOwnPropertyDescriptor(r,s);if(c._proxyMark)continue;if(!c.configurable||void 0===c.value&&!c.set||c.writable===!1)continue;var d="$"===s.charAt(0)&&-1!=t.depends.indexOf(s.substring(1)),l=r[s];N.isObject(l)&&!d&&s!=a&&s!=u&&s!=o&&s!=i&&(N.debug("Exploring "+s),n(l)),N.debug("Observing "+s),e(r,c,s,d)}r.attrs&&N.forIn(r.attrs,function(t,n){-1==h.indexOf(n)&&(t.property||t.value)&&(N.debug("Observing attribute "+n),e(r,null,n),h.push(n))},this)},r=t.obj,h=[];return N.debug("Exploring "+t.name),n(r),r},v={list:{},init:function(t){t.obj.routes&&(N.forIn(t.obj.routes,function(t,e){e=e.toLowerCase(),this.list[e]=new y(e,t.handler)},this),N.debug("Routes init"))},locate:function(e){var n=t.location.hash.substring(1);n=this.find(n),n?(N.debug("Process route "+n.path),q.location=function(e){return e?(this.move(e),null):{href:t.location.href,route:n}}.bind(this),n.handler&&D(n.handler,q.obj),N.forIn(e,function(t){var e=t.obj;e.$location=q.location;var i=n.has(e);e.$shown=i,t.rendered||t.render(),t.validateShow();var r=e.routes;if(r&&i){var s=r[n.path];s&&s.handler&&D(s.handler,e)}}),N.debug("Processed route "+n.path)):q.obj.routes?this.move("/"):(N.debug("Process default route"),N.forIn(e,function(t){t.rendered||t.render(),t.obj.$location=function(){return{route:{has:function(){return!0}}}},t.obj.$shown=!0}),N.debug("Processed default route"))},find:function(t){return this.list[t]},move:function(e){setTimeout(function(){t.location.hash="#"+e},100)}},y=function(t,e){this.path=t,this.handler=e};y.prototype={has:function(t){var e=t.routes;if(e){var n=null!=e["-"],i=!1;return N.forIn(e,function(t,e){return e.toLowerCase()==this.path?(i=!0,!1):!0},this),n!=i}return!1}};var b={},g=function(t,e,n){if(N.isUndefined(e))return b[t];var i={canWrite:!1,changeRoutes:!1,changeAttrs:!1};N.isDefined(n)&&N.extend(i,n);var r={fn:e,opts:i},s=new R(r);return b[t]=s,s},m=function(t){var e=t.split(":");if(this.name=N.trim(e[0]),this.params="",e.length>1){var n=e[1];n=N.trim(n),n="["+n+"]",this.params=n}};m.prototype={process:function(t,e){var n=b[this.name];if(!n)throw Error("Pipe "+this.name+" not found");var i=n.fn,r=[];if(this.params.length>0){var s=N.extend({},t);s=N.extend(s,n);var o=N.convert(this.params,s);N.forEach(o,function(t){t=N.trim(t),r.push(t)})}var a=N.isDefined(e)&&this.canWrite()?t:N.clone(t);return i&&N.isFunction(i)&&(a=D(i,n,!0,a,r,e)),a},canWrite:function(){var t=b[this.name];return t?t.opts.canWrite:!1},changeRoutes:function(){var t=b[this.name];return t?t.opts.changeRoutes:!1},changeAttrs:function(){var t=b[this.name];return t?t.opts.changeAttrs:!1}};var $={type:"GET",mime:"json"},j={script:"text/javascript, application/javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},x=function(t){t&&(t.url&&(this.url=t.url),t.params&&(this.params=t.params),t.headers&&(this.headers=t.headers),t.dataType&&(this.dataType=t.dataType))},E=function(t,e){var n="";e&&(n=e.indexOf("?")+1?"&":"?");var i=n;return N.forIn(t,function(t,e){i!==n&&(i+="&"),i+=e+"="+t}),i===n?"":i},w=function(t,e,n){var i=e.status;i>=200&&300>i||0===i?A(t,C(t,e,n),null):A(t,e.responseText,i)},A=function(t,e,n){t.ok(n,e)},O=function(t,e,n,i){i&&(e["Content-Type"]=i),n&&(e.Accept=j[n]),N.forIn(e,function(e,n){t.setRequestHeader(n,e)})},C=function(t,e,n){var i;if(i=e.responseText)if(n===$.mime)try{i=JSON.parse(i)}catch(r){A(t,i,r)}else"xml"===n&&(i=e.responseXML);return i},S=function(t,e){e&&(t.params?N.extend(t.params,e):t.params=e)},T=function(t,e,n){var i=n;q&&q.connect&&q.connect[e]&&(q.connect[e],i=N.isObject(i)?N.extend(i,r):r);var r=t[e];return r&&(i=N.isObject(i)?N.extend(i,r):r),i},I=function(t){this.xhr=t,this.done=!1};I.prototype={cancel:function(){this.xhr&&this.xhr.abort(),this.done=!1,delete this.data,delete this.err},ok:function(t,e){this.done=!0,this.data=t,this.err=e,this.fn&&D(this.fn,this,!0,t,e)},ready:function(t){this.done&&t?D(this.fn,this,!0,this.data,this.err):this.fn=t}};var k=function(e,n){var i=e.getType(),r=e.getUrl();e.getParams();var s=e.getDataType(),o=e.getContentType(),a=e.getHeaders();if(i===$.type?r+=E(data,r):data=E(data),/=\$JSONP/gi.test(r))return this.jsonp(r,data);var u=new t.XMLHttpRequest,h=I(u);N.isFunction(n)?h.ready(n):N.isObject(n)&&h.ready(function(t,e){e?console.err(e):N.isObject(t)?N.extend(n,t):console.log("Response received"+t)}),u.onreadystatechange=function(){return 4===u.readyState?w(h,u,s):null},u.open(i,r),O(u,a,o,s);try{u.send(data)}catch(c){u=c,A(h,null,c)}return u};x.prototype={jsonp:function(e,n){var i=t.document.getElementsByTagName("head")[0],r=t.document.createElement("script");e+=this.gatherParams(n,e);var s="jsonp"+N.uid(),o=new I(null);return t[s]=function(e){return i.removeChild(r),delete t[s],o.ok(e,null)},r.type="text/javascript",r.src=e.replace(/=\$JSONP/gi,"="+s),i.appendChild(r),o},get:function(t,e,n){return this.type=$.type,delete this.contentType,S(this,t),k(this,e,n)},post:function(t,e,n){return this.form("POST",t,e,n)},put:function(t,e,n){return this.form("PUT",t,e,n)},del:function(t,e,n){return this.form("DELETE",t,e,n)},"delete":function(t,e,n){return this.form("DELETE",t,e,n)},form:function(t,e,n,i){return this.type=t,this.contentType="application/x-www-form-urlencoded",S(this,e),k(this,n,i)},getUrl:function(){var t=T(this,"url","");if(!t)throw Error("URL is not defined")},getParams:function(){return T(this,"params",{})},getType:function(){return T(this,"type",$.type)},getContentType:function(){return T(this,"contentType",null)},getDataType:function(){return T(this,"dataType",$.mime)},getHeaders:function(){return T(this,"header",{})}};var P={next:function(t,e){var n=t.parentNode;N.forEach(e,function(e){n.insertBefore(e,t.nextSibling),t=e})},remove:function(t){var e=t.parentNode;e&&e.removeChild(t)},ready:function(e){"complete"===document.readyState?setTimeout(e,0):t.addEventListener("load",e),t.addEventListener("hashchange",e)}},U=function(t,e){var n=function(n){N.debug("Fired '"+n.type+"' listener on '"+e.name+"' for element "+t.tagName);var i=this.value();i=N.trim(i),this.pipes.length>0?this.pipeline(i):e.obj.value!==i&&(e.obj.value=i)}.bind(this),i=t.getAttribute(c);this.$=t,this._id=N.uid(),this.index=i?parseInt(i):-1,this.tie=t.getAttribute(d),this.bind=e,this.events={},this.isInput=N.eqi(t.tagName,"input"),this.hasCheck=N.eqi(t.type,"radio")||N.eqi(t.type,"checkbox"),this.display=t.style.display,this.shown=!0,this.textEl=null,this.isInput&&(this.hasCheck?(N.debug("Added change listener on '"+e.name+"' for element "+t.tagName),t.addEventListener("change",n)):"oninput"in t?(N.debug("Added input listener on '"+e.name+"' for element "+t.tagName),t.addEventListener("input",n)):(N.debug("Added keydown listener on '"+e.name+"' for element "+t.tagName),t.addEventListener("keydown",function(t){var e=t.keyCode;91===e||e>15&&19>e||e>=37&&40>=e||n(t)})));var r=this.tie.replace(/\.([^.|]+(\.[^.|]+)*)/g,'|property:"$1"').match(/[^|]+/g).splice(1);this.pipes=[],N.forEach(r,function(t){this.pipes.push(new m(t))},this),this.pipeline=function(t){var e=this.bind.obj;return this.pipes.length>0&&N.forEach(this.pipes,function(n){e=N.isDefined(t)?n.process(e,t):n.process(e),n.changeRoutes()&&N.isUndefined(t)&&N.isFunction(e.$location)&&(e.$shown=e.$location().route.has(e))},this),e}};U.prototype={setAttribute:function(t,e){if(n===t)this.value(e);else if(r===t)this.text(e);else if(N.isFunction(e)){var i=this.events[t];i&&this.$.removeEventListener(t,i),i=function(t){t.index=this.index,t.tie=this.tie,D(e,this.bind.obj,this.bind.obj.$ready(),t)}.bind(this),this.events[t]=i,this.$.addEventListener(t,i)}else N.isDefined(e)?this.$.setAttribute(t,e):this.$.setAttribute(t,"")},value:function(t){if(this.hasCheck){if(!N.isDefined(t))return this.$.checked;t?this.$.setAttribute("checked","checked"):this.$.removeAttribute("checked")}else{if(!this.isInput)return this.text(t);if(!N.isDefined(t))return this.$.value;this.$.value=t}return null},text:function(e){return N.isDefined(e)?(this.isInput?(null==this.textEl&&(this.textEl=t.document.createElement("span"),this.next(this.textEl)),this.textEl.textContent=e):this.$.textContent=e,null):this.isInput?this.$.nextSibling.textContent||"":this.$.textContent||""},remove:function(){var t=this.$,e=this.bind.$;e.splice(e.indexOf(this),1),delete this.$,delete this.bind,delete this._id,delete this.isInput,delete this.hasCheck,delete this.events,P.remove(t)},next:function(t){var e=this.$;P.next(e,t)},show:function(t){this.shown!==t&&(t?(this.$.style.display=this.display,null!=this.textEl&&(this.textEl.style.display=this.display)):(this.display=this.$.style.display,this.$.style.display="none",null!=this.textEl&&(this.textEl.style.display="none")),this.shown=t)}};var N={debugEnabled:!1,isUndefined:function(t){return void 0==t},isDefined:function(t){return void 0!=t},isObject:function(t){return null!=t&&"object"==typeof t},isString:function(t){return"string"==typeof t},isNumber:function(t){return"number"==typeof t},isDate:function(t){return"[object Date]"==Object.prototype.toString.apply(t)},isArray:function(t){return Array.isArray(t)||"[object Array]"==Object.prototype.toString.apply(t)},isCollection:function(t){return this.isArray(t)||t instanceof Array||"[object NodeList]"==Object.prototype.toString.apply(t)||"[object NamedNodeMap]"==Object.prototype.toString.apply(t)||"[object Arguments]"==Object.prototype.toString.apply(t)},isFunction:function(t){return"function"==typeof t},isBoolean:function(t){return"boolean"==typeof t},trim:function(t){return this.isString(t)?t.replace(/^\s*/,"").replace(/\s*$/,""):t},lowercase:function(t){return this.isString(t)?t.toLowerCase():t},uppercase:function(t){return this.isString(t)?t.toUpperCase():t},toInt:function(t){return parseInt(t,10)},toFloat:function(t){return parseFloat(t)},eqi:function(t,e){return this.lowercase(t)===this.lowercase(e)},clone:function(t){if(!t||!this.isObject(t))return t;var e=this.isArray(t)?[]:Object.create(Object.getPrototypeOf(t));return e=this.extend(e,t,function(t){return t&&this.isObject(t)&&(t=this.clone(t)),t}.bind(this))},convert:function(t,e){var n=t,i=function(t,n){return N.isString(n)&&"#"==n[0]?e[n.substring(1)]:n};return"true"===t?n=!0:"false"===t?n=!1:/^\d*$/.test(t)?n=-1!=t.indexOf(".")?this.toFloat(t):this.toInt(t):"["==t[0]&&"]"==t[t.length-1]?(t=t.replace(/'/g,'"'),n=JSON.parse(t,i)):"{"==t[0]&&"}"==t[t.length-1]?(t=t.replace(/'/g,'"'),n=JSON.parse(t,i)):('"'==t[0]||"'"==t[0])&&(n=t.substring(1,t.length-1)),n},forEach:function(t,e,n,i){if(n||(n=this),e)if(this.isCollection(t)){var r=-1,s=t.length,o=[];if(i){for(;s>++r;)o.push(t[r]);r=-1}else o=t;for(;s>++r&&e.call(n,o[r],r,t)!==!1;);}else e.call(n,t,0,[t]);return t},forIn:function(t,e,n,i){if(n||(n=this),e)for(var r in t)if((t.hasOwnProperty(r)||i)&&e.call(n,t[r],r,t)===!1)break;return t},uid:function(){return p()+p()+"-"+p()+"-"+p()+"-"+p()+"-"+p()+p()+p()},extend:function(t,e,n){return this.isCollection(t)&&this.isCollection(e)?this.forEach(e,function(e,i){n&&(e=n(e,i)),t.push(e)}):this.forIn(e,function(e,i){n&&(e=n(e,i)),t[i]=e},this),t},debug:function(t,e){this.debugEnabled&&(e&&(console.groupEnd(),console.groupCollapsed(e)),console.log(t))}},R=function(t){N.extend(this,t)};R.prototype=N,R.prototype.$attr=function(t,e){if(this.attrs){var n=this.attrs[t];if(N.isUndefined(e)){if(n)return n.val(this)}else n&&n.property?this.$prop(n.property,e):n&&this.$prop(t,e)}return null},R.prototype.$prop=function(t,e){for(var n=this,i=t.split("."),r=1,s=i.length;s>r;)n=n[i[r-1]],r++;var o=i[s-1];return N.isUndefined(e)?n[o]:(n[o]=e,null)},R.prototype.$ready=function(){var t=!0;return N.forEach(this.$deps,function(e){var n=this["$"+e];return n._empty?(t=!1,!1):!0},this),t};var D=function(t,e,n){var i,r=3;N.isUndefined(n)&&N.isFunction(e.$ready)&&(n=e.$ready(),r=2);try{var s=Array.prototype.slice.call(arguments,r);i=t.apply(e,s)}catch(o){i=void 0,n&&(console.groupCollapsed("User code error"),console.error("Is ready and had an error:"+o.message),console.dir(o),console.groupEnd())}return i},_=function(t,e,i){N.isUndefined(i)&&(i=-1);var r=t.values;return i>=0&&r&&N.isDefined(r[i][e])?r[i][e]:i>=0&&r&&n==e?r[i]:t.$prop(e)},F=function(t,e,n){var i=this.name,r=this.value,s=this.property;if(N.isUndefined(n)&&(n=t.$ready()),N.isFunction(r))return D(r,t,n);if(s&&N.isUndefined(r))return _(t,s,e);if(!i)throw Error("Where is your property?");return _(t,i,e)},L=function(t,e,n){this.name=t,this.touch=[],this.values={},this.depends=e||[],this.rendered=!1,this.loaded=!1,this.loading=!1,this.selected=!1,this.applyCount=0,this.timeout=null,this.e=0,this.apply=function(){this.applyCount++,this.applyCount>10&&N.debug("Too many apply :"+this.name+" - "+this.applyCount),this.rendered&&this.render(),N.forEach(this.touch,function(t){var e=n[t];e&&(e.obj["$"+this.name]=this.obj)},this),this.timeout||(this.timeout=setTimeout(function(){this.timeout=null,this.applyCount=0}.bind(this),3e3))}};L.prototype={prepareRoutes:function(){var t=this.obj.routes;t&&(N.isArray(t)&&(this.obj.routes=t._({})),N.forIn(this.obj.routes,function(t,e){t=N.isFunction(t)?{path:e,handler:t}:{path:e},this.obj.routes[e]=t},this))},prepareAttrs:function(){var t=this.obj.attrs;t&&(N.isArray(t)&&(this.obj.attrs=t._({})),N.forIn(this.obj.attrs,function(t,e){t=N.isString(t)&&"#"==t[0]?{name:e,property:t.substring(1)}:N.isFunction(t)?{name:e,value:t}:t[h]?{name:t[h]}:{name:e,value:t},t.val=F,this.obj.attrs[e]=t},this))},prepareValues:function(){var t=this.obj.values;if(t){if(this.$.length-this.e==t.length)return this.rendered=!1,void 0;var e={},n={};N.forEach(this.$,function(t){t.index>=0&&t.remove()},this,!0),N.forEach(t,function(t,i){N.forEach(this.$,function(t){var r=t._id,s=n[r];s||(n[r]=s=t.$);var o=e[r];o||(e[r]=o=[]);var a=s.cloneNode(!0);s.style.display="",a.setAttribute(c,i),o.push(a)})},this),N.forEach(this.$,function(t){var n=t.$;n.style.display="none",P.next(n,e[t._id])}),this.selected=!1}},show:function(t){this.rendered&&N.forEach(this.$,function(e){e&&e.show(t)},this)},validateShow:function(){this.loaded||this.loading||this.load(),N.forEach(this.$,function(t){if(t){var e=t.pipeline().$shown;e&&!this.rendered&&this.render(),t.show(e)}},this)},render:function(){this.obj.$shown&&(N.debug("Render "+this.name,this.name+" Render"),this.loaded||this.loading||this.load(),N.forEach(this.$,function(t){if(t){var e=t.pipeline(),n=e.$ready(),i=e.attrs,r=t.index;i&&(N.forIn(i,function(i){var s=i.val(e,r,n),o=i.name;N.debug("Render attribute '"+o+"' with value "+s),t.setAttribute(o,s)}),t.setAttribute(l),t.isInput&&t.setAttribute("name",this.name))}},this),this.show(this.obj.$shown),this.rendered=!0,N.debug("Rendered "+this.name))}};var q=null,M=function(){var n={};return function(i,r,s){i!=e&&null==n[e]&&t.tie(e,{});var o=n[i];if(!o||o.obj._empty||!N.isUndefined(s)&&o.depends!==s){var a=M.prototype.init(i,r,s,n);return M.prototype.define(i,a,n),i==e&&(q=a,v.init(q),P.ready(function(){v.locate(n)})),a.obj}return M.prototype.update(o,r)}};M.prototype={select:function(e,n){var i=t.document.querySelectorAll("["+d+'="'+e+'"]'),r=[];return N.forEach(i,function(t){r.push(new U(t,n))}),i=t.document.querySelectorAll("["+d+'^="'+e+'|"]'),N.forEach(i,function(t){r.push(new U(t,n))}),i=t.document.querySelectorAll("["+d+'^="'+e+' |"]'),N.forEach(i,function(t){r.push(new U(t,n))}),i=t.document.querySelectorAll("["+d+'^="'+e+'."]'),N.forEach(i,function(t){r.push(new U(t,n))}),n.selected=!0,r},wrapPrimitive:function(t){return{value:t,attrs:[n]}},wrapFunction:function(t){return{attrs:{value:t}}},wrapArray:function(t){return{values:t,attrs:[n]}},check:function(t){return N.isFunction(t)?t=this.wrapFunction(t):!N.isObject(t)||N.isDate(t)?t=this.wrapPrimitive(t):N.isArray(t)&&(t=this.wrapArray(t)),N.isUndefined(t.$shown)&&(t.$shown=!0),N.isUndefined(t.attrs)&&(t.attrs={}),N.isUndefined(t.routes)&&null!=q&&q.obj.routes&&(t.routes=q.obj.routes),new R(t)},resolve:function(t,e,n){e&&N.forEach(e,function(e){var i=n[e];i||(i={name:e,touch:[],obj:{_empty:!0}},this.define(e,i,n)),t.obj["$"+e]=i.obj,-1==i.touch.indexOf(t.name)&&i.touch.push(t.name)},this)},define:function(t,e,n){var i=n[t];n[t]=e,i&&i.touch&&(e.touch=i.touch,e.rendered=i.rendered,N.debug("Calling apply on '"+e.name+"' after define"),e.apply())},update:function(t,e){var n=t.name;return N.debug("Update tie "+n,n),N.extend(t.obj,this.check(e)),t.prepareAttrs(),t.prepareRoutes(),t.prepareValues(),N.debug("Prepared inner array structure"),t.obj=f(t),t.selected||(this.$=M.select(n,t),N.debug("Elements reselected: "+this.$.length)),t.rendered||t.render(),t},init:function(t,e,n,i){N.debug("Tie "+t,t);var r=new L(t,n,i);r.obj=this.check(e),r.prepareAttrs(),r.prepareRoutes(),this.resolve(r,n,i),r.obj.$deps=r.depends,r.obj=f(r),N.debug("Bind model ready");var s=this;return r.load=function(){this.loading=!0,this.selected||(this.$=s.select(t,r),this.e=this.$.length,N.debug("Elements selected: "+this.$.length)),r.prepareValues(),N.debug("Prepared inner array structure"),this.selected||(this.$=s.select(t,r),N.debug("Elements reselected: "+this.$.length)),this.loaded=!0,this.loading=!1},r}},t.tie=M(),t.tie.pipes=g,g("property",function(t,e,i){if(e){var r=e[0],s=e.length>1?e[1]:n;N.isUndefined(i)?t.$prop(s,t.$prop(r)):t.$prop(r,i)}return t},{canWrite:!0}),g("value",function(t,e){if(e){var n=e[0],i=e.length>1?e[1]:null;t.$prop(n,i)}return t}),g("routes",function(t,e){if(e){var n="+"===e[0],i="-"===e[0];n?(e.splice(0,1),this.forEach(e,function(e){t.routes[e]={path:e}})):i?(e.splice(0,1),this.forEach(e,function(e){delete t.routes[e]})):(t.routes={},this.forEach(e,function(e){t.routes[e]={path:e}}))}return t},{changeRoutes:!0})})(window);